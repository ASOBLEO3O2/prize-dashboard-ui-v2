// src/ui/kpiMid.js
import { el, clear } from "../utils/dom.js";
import { renderMidSlot } from "./renderMidSlot.js";

import { renderWidget1ShareDonut } from "./widget1ShareDonut.js";

/**
 * 中段：2×2（5:4固定の枠は維持）
 * - 4セルは必ず renderMidSlot を通す（枠を消さない）
 * - widget1：既存の描画（body内完結）
 * - widget2：当て先だけ（body内に select + canvas を置く）
 * - それ以外：プレースホルダ表示（枠維持）
 */
export function renderMidKpi(mounts, state, actions) {
  const slotMounts = [
    mounts.midSlotSalesDonut,
    mounts.midSlotMachineDonut,
    mounts.midSlotCostHist,
    mounts.midSlotScatter,
  ];

  const fallback = ["widget1", "widget2", "scatter", "dummyA"];
  const fixed = norm4_(state.midSlots, fallback);
  const draft = norm4_(state.midSlotsDraft, fixed);
  const slots = state.drawerOpen ? draft : fixed;

  for (let i = 0; i < 4; i++) {
    const mount = slotMounts[i];
    if (!mount) continue;

    const type = slots[i] || "dummyA";

    renderMidSlot(mount, {
      slotKey: String(type || "").trim() || "_",
      title: titleOf_(type, i),
      onFocus: () => actions?.onOpenFocus?.({ slotIndex: i, slotType: type }),
      renderBody: (body) => {
        clear(body);

        if (type === "widget1") {
          renderWidget1ShareDonut(body, state, actions);
          return;
        }

        if (type === "widget2") {
          ensureWidget2Body_(body);
          return;
        }

        body.appendChild(
          el("div", { class: "frameOnlyHint" }, [
            el("div", { class: "frameOnlyType", text: `type: ${type}` }),
            el("div", { class: "frameOnlyText", text: "（未復活：枠のみ）" }),
          ])
        );
      },
    });
  }

  if (mounts.midCards) clear(mounts.midCards);
}

function ensureWidget2Body_(body) {
  // charts.js 側の既存描画互換（id固定）
  const wrap = el("div", {
    class: "chartBody",
    style:
      "width:100%;height:100%;min-height:0;display:flex;flex-direction:column;gap:10px;",
  });

  const tools = el(
    "div",
    { class: "chartTools", style: "flex:0 0 auto;display:flex;gap:10px;align-items:center;" },
    [
      el("select", { class: "select", id: "costHistMode" }, [
        el("option", { value: "count", text: "台数" }),
        el("option", { value: "sales", text: "売上" }),
      ]),
    ]
  );

  const canvasWrap = el("div", { style: "position:relative;flex:1;min-height:0;" }, [
    el("canvas", { id: "costHistChart", style: "width:100%;height:100%;" }),
  ]);

  wrap.appendChild(tools);
  wrap.appendChild(canvasWrap);
  body.appendChild(wrap);
}

function titleOf_(type, idx) {
  if (type === "widget1") return "売上構成比";
  if (type === "widget2") return "原価率 分布";
  if (type === "scatter") return "散布図";
  if (type === "dummyA") return `枠${idx + 1}`;
  return String(type || `枠${idx + 1}`);
}

function norm4_(arr, fallback) {
  const a = Array.isArray(arr) ? arr.slice(0, 4) : fallback.slice(0, 4);
  while (a.length < 4) a.push(fallback[a.length] || "dummyA");
  return a.map((x) => String(x || "").trim() || "dummyA");
}

/* ===== Widget1 overlay & legend (append) ===== */

.widget1ChartWrap{
  position: relative; /* ← center/tip を重ねるため必須 */
}

/* 中央文字 */
.w1Center{
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  pointer-events: none;
  text-align: center;
}
.w1CenterLabel{
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .10em;
  color: rgba(148,163,184,.92);
}
.w1CenterValue{
  font-size: 16px;
  font-weight: 900;
  font-variant-numeric: tabular-nums;
  color: rgba(226,232,240,.98);
}

/* ドーナツ内ツールチップ（下部固定） */
.w1Tip{
  position: absolute;
  left: 10px;
  right: 10px;
  bottom: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(15,23,42,.92);
  border: 1px solid rgba(148,163,184,.18);
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  opacity: 0;
  transform: translateY(6px);
  pointer-events: none;
  transition: opacity .12s ease, transform .12s ease;
}
.w1Tip.show{ opacity: 1; transform: translateY(0); }
.w1TipTitle{
  font-size: 12px;
  font-weight: 900;
  color: rgba(226,232,240,.98);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.w1TipLine{
  font-size: 11px;
  font-weight: 800;
  color: rgba(203,213,225,.95);
}

/* 右側凡例（文字が出るように最低限） */
.w1LegendItem{
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 12px;
  padding: 10px;
  margin-bottom: 10px;
  background: rgba(2,6,23,.20);
}
.w1LegendHead{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}
.w1LegendSwatch{
  width: 10px;
  height: 10px;
  border-radius: 3px;
  flex: 0 0 auto;
}
.w1LegendLabel{
  font-size: 12px;
  font-weight: 900;
  color: rgba(226,232,240,.96);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.w1LegendSales{
  font-size: 12px;
  font-weight: 900;
  color: rgba(203,213,225,.98);
  margin-bottom: 6px;
  font-variant-numeric: tabular-nums;
}
.w1LegendShares{
  font-size: 11px;
  color: rgba(148,163,184,.95);
  margin-bottom: 8px;
}
.w1LegendMetaRow{
  display: flex;
  justify-content: space-between;
  gap: 10px;
  font-size: 11px;
  color: rgba(148,163,184,.95);
  font-variant-numeric: tabular-nums;
}
.widget1Note{
  margin-top: 8px;
  font-size: 11px;
  color: rgba(148,163,184,.90);
}
  
